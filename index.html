<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hexo</title>
  
	<style>
		* {
			padding: 0px; 
			margin: 0px;
		}
		body { font-family: sans-serif; }

		.draggable {
			border: 1px rgba(159, 107, 107, 0.14) solid;
			width: 100px;
			height: 100px;
			background: #F90;
			border-radius: 10px;
			position: absolute;
		}
		.draggable.is-pointer-down {
			background: #09F;
		}
		.draggable.is-dragging { opacity: 0.7; }
		
		.container {
			width: 700px;
			height: 500px;
			position: relative;
		}
		.container li {
			list-style: none;
			padding:30px;
			float: left;
			//display: inline-block;
			width: 100px;
			height: 100px;
			//border: 1px solid rgba(93, 95, 67, 0.37)
		}

	</style>

</head>
<body>

	<div class="container">
		<li><div class="draggable">a</div></li>
		<li><div class="draggable">b</div></li>
		<li><div class="draggable">c</div></li>
		<li><div class="draggable">d</div></li>
		<li><div class="draggable">e</div></li>
		<li><div class="draggable">f</div></li>
		<li><div class="draggable">g</div></li>
		<li><div class="draggable">h</div></li>
		<li><div class="draggable">i</div></li>
		<li><div class="draggable">j</div></li>
		<li><div class="draggable">k</div></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
		<li></li>
	</div>
	<script src="//cdn.bootcss.com/jquery/2.2.1/jquery.js"></script>
	<script src="//cdn.bootcss.com/draggabilly/2.1.1/draggabilly.pkgd.js"></script>
	<script>
		/*
			10 10
			10 + 10 + 10 + 100 10
			10 + 10 + 10 + 10 + 10 + 100 10
			10 + 10 + 10 + 10 + 10 + 10 + 10 + 100 10

			10 10 + 10 + 10 + 100
			10 + 10 + 10 + 100 10 + 10 + 10 + 100

			10 + 20 * n + 100 * n
		*/
		
		var offset 	= $('.draggable').offset().left;	// 图标外边界
		var width 	= $('.draggable').width();			// 图标边长
		$(function() {
			var draggable = $('.draggable').draggabilly();
			
			draggable.each(function(i, d) {
				$(d).data('initPosition', $(d).position());
			});
			draggable.on('dragMove', function(event, pointer, moveVector ) {
				var b = getNearestBlock($(this));
				
			}).on('dragEnd', function() {
				var b = getNearestBlock($(this));
				if(b.distance > 50) {	// 如果距离大于50, 则回到原来位置
					$(this).animate($(this).data('initPosition'), 200);
				} else {
					$('.draggable').eq(b.index).animate($(this).data('initPosition'), 200);
					
					console.log($('.draggable').eq(b.index).data('initPosition'));
					$(this).animate($('.draggable').eq(b.index).data('initPosition'), 200);
					
					setTimeout(function() {
						
						var p1 = $(this).parent();
						var p2 = $('.draggable').eq(b.index).parent();
						p2.append($(this));
						p1.append($('.draggable').eq(b.index));
						
						$('.draggable').eq(b.index).data('initPosition', $('.draggable').eq(b.index).position());
						$(this).data('initPosition', $(this).position());
						
					}.bind(this));
				}
			}).on('pointerDown', function(event, pointer) {
				//$(this).parent().css({border: '1px red dashed'})
			}).on('pointerUp', function(event, pointer) {
				//$(this).parent().css({border: '1px white dashed'})
				
			})
		});
		
		
		function getNearestBlock(block) {
			var blockPos = block.position();
			
			return Array.prototype.reduce.call($('.draggable'), function(o, it, i) {
				var distance = o.distance;
				var index = o.index;
				
				var dis = getDistance(blockPos, $(it).position());
				if(block[0] != it && distance > dis) {
					distance = dis;
					index = i;
				}
				return {
					index: index,
					distance: distance
				}
			}, {
				index: -1,
				distance: Number.MAX_VALUE
			});
		}
		function getDistance(p1, p2) {
			return Math.sqrt(Math.pow(p2.left - p1.left, 2) + Math.pow(p2.top - p1.top, 2));
		}
		
		
		
		// 是否有一半以前的覆盖
		function isCoverHalf() {
			
		}
		
		function moveTo(draggable, position) {
			draggable.animate({
				left: position.x,
				top: position.y
			}, 200);
		}
		
		function getPositionByIndex(x, y) {
			function m(n) {
				var p = offset + offset * 2 * n + width * n;
				console.log(p)
				return p;
			}
			return {
				x: m(x),
				y: m(y)
			};
		}
	</script>
</body>
</html>